<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#2e7d32">
  <title>Agri-Culture - Farmers' Map</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="env.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
  <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
  <script>
    (function(){
      const p = new URLSearchParams(location.search);
      if (p.get('embed') === '1') document.body ? document.body.classList.add('embedded') : null;
      if (p.get('embed') === '1') document.documentElement.classList.add('embed');
    })();
  </script>
</head>
<body>
  <!-- Main Content Area -->
  <div class="map-page">
    <div class="map-overlay-controls">
      <button class="map-btn active" data-layer="all">
        <span>üåæ</span> All Farms
      </button>
      <button class="map-btn" data-layer="crops">
        <span>üå±</span> Crops
      </button>
      <button class="map-btn" data-layer="equipment">
        <span>üöú</span> Equipment
      </button>
      <button class="map-btn" data-layer="weather">
        <span>üå§Ô∏è</span> Weather
      </button>
    </div>
    <div id="mapContainer" class="map-iframe"></div>
  </div>

  <script>
    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing map...');
      
      // HERE API Key (loaded from env.js)
      const apiKey = (window && window.ENV && window.ENV.MAPS_API_KEY) ? window.ENV.MAPS_API_KEY : '';
      if (!apiKey) {
        console.warn('HERE Maps API key is missing. Set MAPS_API_KEY in Frontend/env.js');
      }
      
      // MGM Kamothe coordinates (Navi Mumbai, Maharashtra)
      const mgmKamothe = {
        lat: 19.0330,
        lng: 73.0297
      };

      // Enhanced mobile detection
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isTablet = /iPad|Android(?=.*\bMobile\b)(?=.*\bSafari\b)/i.test(navigator.userAgent);
      const isSmallScreen = window.innerWidth <= 480;
      
      console.log('Device detected:', { isMobile, isTablet, isSmallScreen });

      try {
        // Check if HERE API is loaded
        if (typeof H === 'undefined') {
          console.error('HERE Maps API not loaded');
          document.getElementById('mapContainer').innerHTML = `
            <div style="
              padding: 40px 20px; 
              text-align: center; 
              color: #d32f2f; 
              background: rgba(255, 255, 255, 0.95);
              border-radius: 12px;
              margin: 20px;
              box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            ">
              <div style="font-size: 48px; margin-bottom: 16px;">üó∫Ô∏è</div>
              <h3 style="margin: 0 0 8px 0; color: #d32f2f;">Map Loading Error</h3>
              <p style="margin: 0; color: #666;">HERE Maps API failed to load. Please check your internet connection and try again.</p>
            </div>
          `;
          return;
        }

        console.log('HERE API loaded, creating platform...');

        // Initialize the platform
        const platform = new H.service.Platform({ apikey: apiKey });

        console.log('Platform created, getting default layers...');

        // Get the default map types from the platform object
        const defaultLayers = platform.createDefaultLayers();

        console.log('Default layers obtained, creating map...');

        // Enhanced mobile-optimized map configuration
        const mapConfig = {
          zoom: isMobile ? 14 : 15,
          center: mgmKamothe,
          pixelRatio: window.devicePixelRatio || 1,
          padding: { top: 60, right: 60, bottom: 60, left: 60 }
        };

        // Create a map instance
        const map = new H.Map(
          document.getElementById('mapContainer'),
          defaultLayers.vector.normal.map,
          mapConfig
        );

        console.log('Map created successfully');

        // Enable the event system on the map instance
        const mapEvents = new H.mapevents.MapEvents(map);

        // Add the behavior for different map interactions
        const behavior = new H.mapevents.Behavior(mapEvents);

        // Enhanced mobile-optimized UI configuration
        const uiConfig = {
          zoom: {
            slider: true,
            mouseWheel: true,
            keyboard: false
          },
          mapSettings: {
            H: 'hidden'
          },
          scalebar: {
            H: isMobile ? 'hidden' : 'visible'
          }
        };

        // Create the default UI components with mobile optimizations
        const ui = H.ui.UI.createDefault(map, defaultLayers, 'en-US', uiConfig);

        // Enhanced UI adjustments for mobile
        if (isMobile) {
          // Move zoom controls to bottom right for easier thumb access
          const zoomControl = ui.getControl('zoom');
          if (zoomControl) {
            zoomControl.setAlignment('bottom-right');
          }
          
          // Adjust map settings control position
          const mapSettingsControl = ui.getControl('mapsettings');
          if (mapSettingsControl) {
            mapSettingsControl.setAlignment('bottom-left');
          }
        }

        // Load farm data from API
        console.log('Loading farm data from API...');
        await loadFarmData(map, ui, isMobile);

        // Function to load and display farm data from API
        async function loadFarmData(map, ui, isMobile) {
          try {
            // Get API configuration
            const configResponse = await fetch('/api/config');
            const config = await configResponse.json();
            const baseUrl = config.ENROLL_API_BASE || 'http://localhost:5000';
            
            // Fetch farm data from API
            const response = await fetch(`${baseUrl}/api/map/farms`);
            const data = await response.json();
            
            let farmData = [];
            if (data.success && data.data.farms) {
              // Transform API data to map format
              farmData = data.data.farms.map(farm => ({
                id: farm.id,
                name: farm.name,
                type: farm.type,
                lat: parseFloat(farm.latitude),
                lng: parseFloat(farm.longitude),
                description: farm.description,
                status: farm.status,
                icon: farm.icon || 'üåæ',
                address: farm.address,
                contactPhone: farm.contactPhone,
                contactEmail: farm.contactEmail,
                operatingHours: farm.operatingHours,
                facilities: farm.facilities,
                crops: farm.crops,
                equipment: farm.equipment,
                services: farm.services
              }));
              console.log(`Loaded ${farmData.length} farms from API`);
            } else {
              console.warn('No farm data received from API, using fallback data');
              // Fallback data in case API fails
              farmData = [
                {
                  id: 1,
                  name: "Green Valley Farm",
                  type: "crops",
                  lat: 19.0350,
                  lng: 73.0310,
                  description: "Wheat and Rice cultivation",
                  status: "active",
                  icon: "üåæ"
                },
                {
                  id: 2,
                  name: "Equipment Hub",
                  type: "equipment",
                  lat: 19.0370,
                  lng: 73.0320,
                  description: "Tractors and farming equipment available",
                  status: "available",
                  icon: "üöú"
                }
              ];
            }
          } catch (error) {
            console.error('Error loading farm data:', error);
            // Use fallback data on error
            farmData = [
              {
                id: 1,
                name: "Green Valley Farm (Local)",
                type: "crops",
                lat: 19.0350,
                lng: 73.0310,
                description: "Sample farm - API connection failed",
                status: "active",
                icon: "üåæ"
              }
            ];
          }

        // Create enhanced markers for each farm
        const markers = [];
        const markerGroups = {
          all: [],
          crops: [],
          equipment: [],
          weather: []
        };

        farmData.forEach(farm => {
          // Enhanced custom marker icon based on type and device
          let iconUrl = 'data:image/svg+xml;base64,';
          let svg = '';
          const markerSize = isMobile ? 36 : 40;
          const strokeWidth = isMobile ? 2.5 : 3;
          
          switch(farm.type) {
            case 'crops':
              svg = `<svg width="${markerSize}" height="${markerSize}" viewBox="0 0 ${markerSize} ${markerSize}" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <linearGradient id="cropGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#4CAF50;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#2E7D32;stop-opacity:1" />
                  </linearGradient>
                </defs>
                <circle cx="${markerSize/2}" cy="${markerSize/2}" r="${markerSize/2-2}" fill="url(#cropGrad)" stroke="#1B5E20" stroke-width="${strokeWidth}"/>
                <path d="M${markerSize/4} ${markerSize/4} L${markerSize*3/4} ${markerSize*3/4} M${markerSize*3/4} ${markerSize/4} L${markerSize/4} ${markerSize*3/4}" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
              </svg>`;
              break;
            case 'equipment':
              svg = `<svg width="${markerSize}" height="${markerSize}" viewBox="0 0 ${markerSize} ${markerSize}" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <linearGradient id="equipGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#FF9800;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#F57C00;stop-opacity:1" />
                  </linearGradient>
                </defs>
                <circle cx="${markerSize/2}" cy="${markerSize/2}" r="${markerSize/2-2}" fill="url(#equipGrad)" stroke="#E65100" stroke-width="${strokeWidth}"/>
                <path d="M${markerSize/4} ${markerSize/2} L${markerSize*3/4} ${markerSize/2} M${markerSize/2} ${markerSize/4} L${markerSize/2} ${markerSize*3/4}" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
              </svg>`;
              break;
            case 'weather':
              svg = `<svg width="${markerSize}" height="${markerSize}" viewBox="0 0 ${markerSize} ${markerSize}" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <linearGradient id="weatherGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#2196F3;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#1976D2;stop-opacity:1" />
                  </linearGradient>
                </defs>
                <circle cx="${markerSize/2}" cy="${markerSize/2}" r="${markerSize/2-2}" fill="url(#weatherGrad)" stroke="#0D47A1" stroke-width="${strokeWidth}"/>
                <path d="M${markerSize/4} ${markerSize*7/16} L${markerSize*3/4} ${markerSize*7/16} M${markerSize*7/16} ${markerSize*9/16} L${markerSize*9/16} ${markerSize*9/16}" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
              </svg>`;
              break;
            default:
              svg = `<svg width="${markerSize}" height="${markerSize}" viewBox="0 0 ${markerSize} ${markerSize}" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <linearGradient id="defaultGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#9C27B0;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#7B1FA2;stop-opacity:1" />
                  </linearGradient>
                </defs>
                <circle cx="${markerSize/2}" cy="${markerSize/2}" r="${markerSize/2-2}" fill="url(#defaultGrad)" stroke="#4A148C" stroke-width="${strokeWidth}"/>
                <path d="M${markerSize/2} ${markerSize/4} L${markerSize/2} ${markerSize*3/4} M${markerSize/4} ${markerSize/2} L${markerSize*3/4} ${markerSize/2}" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
              </svg>`;
          }
          
          iconUrl += btoa(svg);

          // Create marker
          const marker = new H.map.Marker(
            { lat: farm.lat, lng: farm.lng },
            {
              icon: new H.map.Icon(iconUrl, { size: { w: markerSize, h: markerSize } })
            }
          );

          // Enhanced info bubble with better mobile styling
          const bubbleContent = `
            <div style="
              padding: ${isMobile ? '16px' : '20px'}; 
              max-width: ${isMobile ? '280px' : '320px'};
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            ">
              <div style="
                display: flex;
                align-items: center;
                margin-bottom: 12px;
                gap: 10px;
              ">
                <span style="font-size: ${isMobile ? '24px' : '28px'}; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">${farm.icon}</span>
                <h3 style="
                  margin: 0; 
                  color: #2e7d32; 
                  font-size: ${isMobile ? '1.2rem' : '1.3rem'};
                  font-weight: 700;
                  line-height: 1.2;
                  text-shadow: 0 1px 2px rgba(0,0,0,0.05);
                ">${farm.name}</h3>
              </div>
              <p style="
                margin: 0 0 12px 0; 
                color: #555; 
                font-size: ${isMobile ? '1rem' : '1.1rem'};
                line-height: 1.5;
                font-weight: 400;
              ">${farm.description}</p>
              <div style="
                display: inline-block;
                padding: 6px 12px;
                background: ${farm.status === 'active' ? 'linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%)' : farm.status === 'available' ? 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)' : 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)'};
                color: ${farm.status === 'active' ? '#2e7d32' : farm.status === 'available' ? '#f57c00' : '#1976d2'};
                border-radius: 16px;
                font-size: ${isMobile ? '0.9rem' : '0.95rem'};
                font-weight: 700;
                text-transform: capitalize;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                border: 1px solid ${farm.status === 'active' ? 'rgba(46, 125, 50, 0.2)' : farm.status === 'available' ? 'rgba(245, 124, 0, 0.2)' : 'rgba(25, 118, 210, 0.2)'};
              ">${farm.status}</div>
            </div>
          `;

          const bubble = new H.ui.InfoBubble(
            { lat: farm.lat, lng: farm.lng },
            { content: bubbleContent }
          );

          // Add click/tap event to marker
          marker.addEventListener('tap', function() {
            ui.addBubble(bubble);
          });

          // Add marker to map
          map.addObject(marker);
          markers.push(marker);
          markerGroups.all.push(marker);
          
          if (farm.type !== 'all') {
            markerGroups[farm.type].push(marker);
          }
        });

        // Enhanced MGM Kamothe marker
        const mgmMarkerSize = isMobile ? 44 : 48;
        const mgmMarker = new H.map.Marker(
          mgmKamothe,
          {
            icon: new H.map.Icon('data:image/svg+xml;base64,' + btoa(`
              <svg width="${mgmMarkerSize}" height="${mgmMarkerSize}" viewBox="0 0 ${mgmMarkerSize} ${mgmMarkerSize}" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <linearGradient id="mgmGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#E91E63;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#C2185B;stop-opacity:1" />
                  </linearGradient>
                  <filter id="glow">
                    <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                    <feMerge> 
                      <feMergeNode in="coloredBlur"/>
                      <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                  </filter>
                </defs>
                <circle cx="${mgmMarkerSize/2}" cy="${mgmMarkerSize/2}" r="${mgmMarkerSize/2-3}" fill="url(#mgmGrad)" stroke="#AD1457" stroke-width="3" filter="url(#glow)"/>
                <text x="${mgmMarkerSize/2}" y="${mgmMarkerSize*5/8}" text-anchor="middle" fill="#fff" font-size="${isMobile ? '11' : '12'}" font-weight="bold" font-family="Arial, sans-serif">MGM</text>
              </svg>
            `), { size: { w: mgmMarkerSize, h: mgmMarkerSize } })
          }
        );

        const mgmBubble = new H.ui.InfoBubble(
          mgmKamothe,
          { 
            content: `
              <div style="
                padding: ${isMobile ? '16px' : '20px'}; 
                max-width: ${isMobile ? '280px' : '320px'};
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              ">
                <div style="
                  display: flex;
                  align-items: center;
                  margin-bottom: 12px;
                  gap: 10px;
                ">
                  <span style="font-size: ${isMobile ? '24px' : '28px'}; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">üè´</span>
                  <h3 style="
                    margin: 0; 
                    color: #E91E63; 
                    font-size: ${isMobile ? '1.2rem' : '1.3rem'};
                    font-weight: 700;
                    line-height: 1.2;
                    text-shadow: 0 1px 2px rgba(0,0,0,0.05);
                  ">MGM Kamothe</h3>
                </div>
                <p style="
                  margin: 0 0 12px 0; 
                  color: #555; 
                  font-size: ${isMobile ? '1rem' : '1.1rem'};
                  line-height: 1.5;
                  font-weight: 400;
                ">College Campus - Agri-Culture Project Center</p>
                <div style="
                  display: inline-block;
                  padding: 6px 12px;
                  background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
                  color: #E91E63;
                  border-radius: 16px;
                  font-size: ${isMobile ? '0.9rem' : '0.95rem'};
                  font-weight: 700;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                  border: 1px solid rgba(233, 25, 99, 0.2);
                ">Project Center</div>
    </div>
            `
          }
        );

        mgmMarker.addEventListener('tap', function() {
          ui.addBubble(mgmBubble);
        });

        map.addObject(mgmMarker);

        // Enhanced layer control functionality with mobile optimizations
        let currentLayer = 'all';
        
        document.querySelectorAll('.map-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            // Prevent double-tap zoom on mobile
            e.preventDefault();
            
            // Add haptic feedback for mobile
            if (navigator.vibrate) {
              navigator.vibrate(50);
            }
            
            // Remove active class from all buttons
            document.querySelectorAll('.map-btn').forEach(b => b.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            
            const layer = this.getAttribute('data-layer');
            currentLayer = layer;
            
            // Hide all markers
            markers.forEach(marker => {
              map.removeObject(marker);
            });
            
            // Show markers for selected layer
            markerGroups[layer].forEach(marker => {
              map.addObject(marker);
            });
            
            // Always show MGM marker
            map.addObject(mgmMarker);
          });
        });

        // Enhanced resize handling for mobile
        let resizeTimeout;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            map.getViewModel().setLookAtData({
              bounds: map.getViewModel().getLookAtData().bounds
            });
          }, 250);
        });

        // Enhanced mobile touch handling
        if (isMobile) {
          let lastTouchEnd = 0;
          document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
              event.preventDefault();
            }
            lastTouchEnd = now;
          }, false);
          
          // Prevent zoom on double-tap for map container
          document.getElementById('mapContainer').addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
              event.preventDefault();
            }
            lastTouchEnd = now;
          }, false);
        }

        console.log('Enhanced map initialization completed successfully');

      } catch (error) {
        console.error('Error initializing map:', error);
        document.getElementById('mapContainer').innerHTML = `
          <div style="
            padding: 40px 20px; 
            text-align: center; 
            color: #d32f2f; 
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            margin: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
          ">
            <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
            <h3 style="margin: 0 0 8px 0; color: #d32f2f;">Map Error</h3>
            <p style="margin: 0; color: #666;">Failed to initialize map. Please try refreshing the page.</p>
  </div>
        `;
      }
    });
  </script>
</body>
</html> 