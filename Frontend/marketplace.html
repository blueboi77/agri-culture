<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agri-Culture - Marketplace</title>
  <link rel="stylesheet" href="style.css"/>
  <script>
    (function(){
      const p = new URLSearchParams(location.search);
      if (p.get('embed') === '1') document.body ? document.body.classList.add('embedded') : null;
      if (p.get('embed') === '1') document.documentElement.classList.add('embed');
    })();
  </script>
</head>
<body>
  <!-- Main Content Area -->
  <div class="content-inner">
    <div class="content-section">
      <h2 data-i18n="market">Marketplace</h2>
      <div class="market-tabs">
        <button class="tab-link active" onclick="openMarketTab(event, 'buy')" data-i18n="buy">Buy</button>
        <button class="tab-link" onclick="openMarketTab(event, 'bid')" data-i18n="bid">Bid</button>
        <button class="tab-link" onclick="openMarketTab(event, 'rent')" data-i18n="rent">Rent</button>
      </div>
      
      <div id="buy" class="tab-content" style="display:block;">
        <div class="loading-indicator" id="buy-loading" style="display:none;text-align:center;padding:20px;">Loading products...</div>
        <div class="error-message" id="buy-error" style="display:none;text-align:center;padding:20px;color:red;"></div>
        <div class="market-items" id="buy-items">
          <!-- Dynamic content will be loaded here -->
        </div>
      </div>
      
      <div id="bid" class="tab-content">
        <div class="bid-section-header">
          <h3>Live Auctions</h3>
          <p>Place your bids on agricultural equipment and supplies</p>
        </div>
        <div class="loading-indicator" id="bid-loading" style="display:none;text-align:center;padding:20px;">Loading auctions...</div>
        <div class="error-message" id="bid-error" style="display:none;text-align:center;padding:20px;color:red;"></div>
        <div class="market-items" id="bid-items">
          <!-- Dynamic content will be loaded here -->
        </div>
      </div>
      
      <div id="rent" class="tab-content">
        <div class="rent-section-header">
          <h3>Equipment Rental</h3>
          <p>Rent agricultural equipment for your farming needs</p>
        </div>
        <div class="loading-indicator" id="rent-loading" style="display:none;text-align:center;padding:20px;">Loading rentals...</div>
        <div class="error-message" id="rent-error" style="display:none;text-align:center;padding:20px;color:red;"></div>
        <div class="market-items" id="rent-items">
          <!-- Dynamic content will be loaded here -->
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <script src="script.js"></script>
  <script>
    let socket;
    
    // Initialize Socket.io connection
    function initializeSocket() {
      socket = io('http://localhost:5000', {
        transports: ['websocket', 'polling']
      });
      
      socket.on('connect', () => {
        console.log('ðŸ”Œ Connected to Socket.io server');
      });
      
      socket.on('disconnect', () => {
        console.log('ðŸ”Œ Disconnected from Socket.io server');
      });
      
      // Listen for new bid notifications
      socket.on('newBid', (bidData) => {
        console.log('ðŸ”¥ New bid received:', bidData);
        handleNewBidNotification(bidData);
      });
      
      socket.on('productBidUpdate', (bidData) => {
        console.log('ðŸ“ˆ Product bid update:', bidData);
        updateProductBid(bidData);
      });
    }
    
    // Handle new bid notifications
    function handleNewBidNotification(bidData) {
      // Show a toast notification
      showBidNotification(bidData);
      
      // Update the bid items if currently viewing bid tab
      if (document.getElementById('bid').style.display !== 'none') {
        updateBidItem(bidData);
      }
      
      // Play a subtle notification sound (optional)
      playNotificationSound();
    }
    
    // Show toast notification for new bids
    function showBidNotification(bidData) {
      const notification = document.createElement('div');
      notification.className = 'bid-notification';
      notification.innerHTML = `
        <div class="notification-content">
          <span class="notification-icon">ðŸ”¥</span>
          <span class="notification-text">
            New bid of â‚¹${bidData.amount} on ${bidData.productName}
          </span>
        </div>
      `;
      
      // Add notification styles if not already present
      if (!document.querySelector('style[data-notification-styles]')) {
        const styles = document.createElement('style');
        styles.setAttribute('data-notification-styles', 'true');
        styles.textContent = `
          .bid-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-in 2.7s;
            animation-fill-mode: forwards;
            max-width: 300px;
          }
          .notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
          }
          .notification-icon {
            font-size: 18px;
          }
          .notification-text {
            font-size: 14px;
            font-weight: 500;
          }
          @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
          }
        `;
        document.head.appendChild(styles);
      }
      
      document.body.appendChild(notification);
      
      // Remove notification after animation
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 3000);
    }
    
    // Update specific bid item in the bid tab
    function updateBidItem(bidData) {
      const bidItems = document.getElementById('bid-items');
      const productCards = bidItems.querySelectorAll('.market-item');
      
      productCards.forEach(card => {
        const productId = card.getAttribute('data-product-id');
        if (productId === bidData.productId) {
          // Update the current bid display
          const bidAmount = card.querySelector('.bid-amount');
          if (bidAmount) {
            bidAmount.textContent = `â‚¹${bidData.amount}`;
            bidAmount.style.animation = 'bidUpdate 0.5s ease-in-out';
          }
          
          // Update bid count if available
          const bidCount = card.querySelector('.bid-count');
          if (bidCount) {
            const currentCount = parseInt(bidCount.textContent.match(/\d+/)[0]) || 0;
            bidCount.textContent = `${currentCount + 1} bids`;
          }
          
          // Add visual highlight
          card.style.animation = 'bidHighlight 1s ease-in-out';
        }
      });
      
      // Add bid animation styles if not present
      if (!document.querySelector('style[data-bid-animations]')) {
        const styles = document.createElement('style');
        styles.setAttribute('data-bid-animations', 'true');
        styles.textContent = `
          @keyframes bidUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); color: #4CAF50; }
            100% { transform: scale(1); }
          }
          @keyframes bidHighlight {
            0% { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
            50% { box-shadow: 0 8px 24px rgba(76, 175, 80, 0.3); }
            100% { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
          }
        `;
        document.head.appendChild(styles);
      }
    }
    
    // Update product bid details
    function updateProductBid(bidData) {
      updateBidItem(bidData);
    }
    
    // Play notification sound (optional)
    function playNotificationSound() {
      // Create a subtle notification sound using Web Audio API
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.1);
        
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
      } catch (error) {
        // Silently fail if audio context is not available
        console.log('Audio notification not available');
      }
    }
    
    // Initialize marketplace data when page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadProducts();
      loadBiddingProducts();
      loadRentals();
      initializeSocket();
    });
    
    // Clean up socket connection when page unloads
    window.addEventListener('beforeunload', function() {
      if (socket) {
        socket.disconnect();
      }
    });
  </script>
</body>
</html> 